# å¿«é€Ÿå‚è€ƒï¼šV3 æ¨ç†è„šæœ¬ä¿®å¤æ¸…å•

## ä¿®å¤æ¦‚è§ˆ

| ä¿®å¤é¡¹ | V3ï¼ˆåŸå§‹ï¼‰ | V3ï¼ˆä¿®å¤åï¼‰ | å½±å“ç­‰çº§ |
|--------|----------|-----------|--------|
| **è§†é¢‘å¸§åŠ è½½** | âŒ è™šæ‹Ÿå›¾åƒï¼ˆå…¨é»‘ï¼‰ | âœ… çœŸå®è§†é¢‘å¸§ | ğŸ”´ ä¸¥é‡ |
| **å¸§å¯¹åº”å…³ç³»** | âŒ ç›´æ¥ç´¢å¼• | âœ… ä½¿ç”¨ frame_index | ğŸ”´ ä¸¥é‡ |
| **Prompt å­—æ®µ** | âŒ æ‰‹åŠ¨æ·»åŠ  | âœ… ä¸æ·»åŠ  | ğŸŸ  ä¸­ç­‰ |
| **æ•°æ®éªŒè¯** | âš ï¸ åŸºç¡€æ£€æŸ¥ | âœ… å®Œæ•´éªŒè¯ | ğŸŸ¡ ä½ |

---

## å…³é”®å˜æ›´è¯¦è§£

### 1ï¸âƒ£ è§†é¢‘å¸§åŠ è½½

**ä¹‹å‰**ï¼ˆé”™è¯¯ï¼‰ï¼š
```python
dummy_image = np.zeros((224, 224, 3), dtype=np.uint8)  # âŒ å…¨é»‘å›¾åƒ
obs = {
    "state": state,
    "image": dummy_image
}
```

**ä¹‹å**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```python
# 1. åŠ è½½çœŸå®è§†é¢‘å¸§
mp4reader = MP4Reader(..., resolution=(224, 224))
video_frames = mp4reader.read_all_frames()

# 2. æ¨ç†æ—¶ä½¿ç”¨çœŸå®å¸§
frame_idx = int(frame_indices[i])
image = video_frames[frame_idx]
obs = {
    "state": state,
    "image": image  # âœ… çœŸå®è§†é¢‘å¸§
}
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- æ¨¡å‹åœ¨è®­ç»ƒæ—¶çœ‹åˆ°çš„æ˜¯çœŸå®è§†é¢‘å¸§
- æ¨ç†æ—¶å¦‚æœç”¨è™šæ‹Ÿå›¾åƒï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„åˆ†å¸ƒåå·®
- å›¾åƒç‰¹å¾å®Œå…¨ä¸åŒï¼Œæ¨¡å‹æ€§èƒ½å¤§å¹…ä¸‹é™

---

### 2ï¸âƒ£ å¸§å¯¹åº”å…³ç³»

**æ ¸å¿ƒé—®é¢˜**ï¼š
- è§†é¢‘æ€»å¸§æ•°ï¼š3233
- Parquet æ ·æœ¬æ•°ï¼š1300
- ä¸æ˜¯ç®€å•çš„çº¿æ€§å…³ç³»ï¼

**ä¹‹å‰**ï¼ˆé”™è¯¯ï¼‰ï¼š
```python
# âŒ å‡è®¾ä¸€ä¸€å¯¹åº”
for i in range(len(states)):
    obs["image"] = processed_images[i]  # å¯èƒ½è¶Šç•Œæˆ–ç”¨é”™å¸§
```

**ä¹‹å**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```python
# âœ… ä½¿ç”¨ frame_index å­—æ®µ
frame_indices = df['frame_index'].values.astype(np.int32)

for i in range(len(states)):
    frame_idx = int(frame_indices[i])
    if frame_idx >= len(video_frames):
        frame_idx = len(video_frames) - 1

    image = video_frames[frame_idx]  # æ­£ç¡®çš„å¸§
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- parquet ä¸­æ¯ä¸€è¡Œéƒ½æ˜ç¡®æŒ‡å®šäº†å¯¹åº”çš„è§†é¢‘å¸§ç´¢å¼•
- ä¸ä½¿ç”¨å®ƒä¼šå¯¼è‡´ state å’Œ image é”™é…
- ç›´æ¥ç´¢å¼•ä¼šå¯¼è‡´æŸäº›å¸§è¢«è·³è¿‡æˆ–æŸäº›å¸§è¢«é‡å¤ä½¿ç”¨

---

### 3ï¸âƒ£ Prompt å­—æ®µ

**ä¹‹å‰**ï¼ˆé”™è¯¯ï¼‰ï¼š
```python
obs = {
    "state": state,
    "image": image,
    "prompt": "predict excavator joint action from joint state"  # âŒ ä¸åº”è¯¥æœ‰
}
```

**ä¹‹å**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```python
obs = {
    "state": state,
    "image": image,
}
# âœ… ä¸æ·»åŠ  prompt å­—æ®µ
# å¦‚æœæ¨¡å‹éœ€è¦ promptï¼Œç”± model_transforms ä¸­çš„ InjectDefaultPrompt å¤„ç†
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- æ¨¡å‹è®­ç»ƒæ—¶æ²¡æœ‰ä½¿ç”¨æ–‡æœ¬é©±åŠ¨çš„ prompt
- æ·»åŠ è™šæ‹Ÿ prompt å¼•å…¥ä¸å¿…è¦çš„å˜é‡
- è®© model çš„ transforms å¤„ç† prompt æ³¨å…¥æ›´æ¸…æ™°

---

## æ•°æ®é›†æ–‡ä»¶è·¯å¾„

é‡è¦çš„æ•°æ®é›†æ–‡ä»¶ä½ç½®ï¼š

```
/root/gpufree-data/lerobot_examples_490_test/
â”œâ”€â”€ meta/
â”‚   â”œâ”€â”€ info.json           # å…³é”®ï¼šåŒ…å« frame_index ç­‰å­—æ®µå®šä¹‰
â”‚   â”œâ”€â”€ modality.json       # æ•°æ®æ¨¡æ€å®šä¹‰
â”‚   â””â”€â”€ stats.json
â”œâ”€â”€ data/
â”‚   â””â”€â”€ chunk-000/
â”‚       â””â”€â”€ episode_000000.parquet  # å…³é”®ï¼šåŒ…å« frame_index åˆ—
â””â”€â”€ videos/
    â””â”€â”€ chunk-000/
        â””â”€â”€ main/
            â””â”€â”€ episode_000000.mp4  # è§†é¢‘æ•°æ®æº
```

## éªŒè¯æ¸…å•

è¿è¡Œæ¨ç†å‰ï¼Œç¡®è®¤ï¼š

- [ ] `meta/info.json` ä¸­æœ‰ `"main"` è§†é¢‘å­—æ®µ
- [ ] `meta/info.json` ä¸­æœ‰ `"frame_index"` å­—æ®µå®šä¹‰
- [ ] Parquet ä¸­ç¡®å®æœ‰ `"frame_index"` åˆ—
- [ ] è§†é¢‘æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»
- [ ] å¸§æ•°åŒ¹é…ï¼š`max(frame_index) < total_frames`

```python
import pandas as pd
import json

# æ£€æŸ¥ meta
with open("meta/info.json") as f:
    meta = json.load(f)
    assert "main" in meta["features"]
    assert "frame_index" in meta["features"]

# æ£€æŸ¥ parquet
df = pd.read_parquet("data/chunk-000/episode_000000.parquet")
assert "frame_index" in df.columns
print(f"Frame index range: [{df['frame_index'].min()}, {df['frame_index'].max()}]")
```

---

## æ¨ç†å‘½ä»¤

```bash
cd /home/er/Code/openpi-v1/openpi/src/openpi/excavator

# è¿è¡Œä¿®å¤åçš„æ¨ç†è„šæœ¬
python test_infer_v3.py

# è¾“å‡ºä½ç½®
# output_v3/
# â”œâ”€â”€ v3_1_time_series.png
# â”œâ”€â”€ v3_2_error_analysis.png
# â”œâ”€â”€ v3_3_error_distribution.png
# â”œâ”€â”€ v3_predictions.csv
# â””â”€â”€ v3_stats.json
```

---

## ç›¸å…³æ–‡æ¡£

- `[13]_é…ç½®ä¸æ•°æ®æ ¼å¼æ ¸å¿ƒé—®é¢˜åˆ†æ.md` - è¯¦ç»†çš„é—®é¢˜åˆ†æ
- `droid_policy.py:85-160` - ExcavatorInputs ç±»å®ç°
- `test_infer_v3.py` - ä¿®å¤åçš„å®Œæ•´æ¨ç†è„šæœ¬

---

## å¸¸è§é”™è¯¯

### âŒ é”™è¯¯ 1ï¼šFileNotFoundError: æ‰¾ä¸åˆ° frame_index åˆ—
**åŸå› **ï¼šParquet æ–‡ä»¶ä¸åŒ…å« frame_index
**è§£å†³**ï¼šç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ•°æ®é›†ç‰ˆæœ¬

### âŒ é”™è¯¯ 2ï¼šIndexError: å¸§ç´¢å¼•è¶…å‡ºèŒƒå›´
**åŸå› **ï¼šframe_index å€¼å¤§äºç­‰äºè§†é¢‘å¸§æ•°
**è§£å†³**ï¼šè„šæœ¬ä¸­å·²æ·»åŠ æ£€æŸ¥å’Œæˆªæ–­é€»è¾‘

### âŒ é”™è¯¯ 3ï¼šå…¨é»‘è¾“å‡ºæˆ–æ€§èƒ½å¾ˆå·®
**åŸå› **ï¼šè¿˜åœ¨ä½¿ç”¨è™šæ‹Ÿå›¾åƒ
**è§£å†³**ï¼šç¡®ä¿ `mp4reader.read_all_frames()` è¢«è°ƒç”¨ä¸”è¿”å›çœŸå®å¸§

---

## æ€§èƒ½é¢„æœŸ

ä¿®å¤åçš„æ¨ç†åº”è¯¥ï¼š
- âœ… èƒ½æ­£ç¡®åŠ è½½ ~1300 ä¸ªæ ·æœ¬
- âœ… ç”Ÿæˆæœ‰æ„ä¹‰çš„è¯¯å·®åˆ†æå›¾è¡¨
- âœ… J4ï¼ˆå›è½¬å…³èŠ‚ï¼‰çš„ MAE åº”åœ¨åˆç†èŒƒå›´å†…
- âœ… è¯¯å·®åˆ†å¸ƒåº”è¯¥ç±»ä¼¼æ­£æ€åˆ†å¸ƒè€Œéå‡åŒ€åˆ†å¸ƒ

å¦‚æœè¾“å‡ºä»ç„¶ä¸ç†æƒ³ï¼Œæ£€æŸ¥ï¼š
1. æ˜¯å¦ä½¿ç”¨äº†çœŸå®è§†é¢‘å¸§ï¼Ÿ
2. å¸§å¯¹åº”å…³ç³»æ˜¯å¦æ­£ç¡®ï¼Ÿ
3. æ¨¡å‹æ£€æŸ¥ç‚¹æ˜¯å¦æ­£ç¡®åŠ è½½ï¼Ÿ
