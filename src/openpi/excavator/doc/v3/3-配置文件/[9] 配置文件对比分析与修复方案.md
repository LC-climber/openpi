# ğŸ” é…ç½®æ–‡ä»¶å¯¹æ¯”åˆ†æä¸é—®é¢˜è¯Šæ–­

## âš ï¸ æ ¸å¿ƒå‘ç°ï¼šä¸¤å¥—é…ç½®å­˜åœ¨æ˜æ˜¾å·®å¼‚

### å‘ç°1ï¼šé…ç½®æ–‡ä»¶ä½ç½®

æ‚¨ä½¿ç”¨çš„è®­ç»ƒé…ç½®æ¥è‡ªä¸¤ä¸ªä½ç½®ï¼š

| ä½ç½® | æ–‡ä»¶è·¯å¾„ | çŠ¶æ€ |
|------|---------|------|
| **excavatorç›®å½•** | `/src/openpi/excavator/training/config.py` | âš ï¸ æœ‰é”™è¯¯ |
| **excavatorç›®å½•** | `/src/openpi/excavator/policies/droid_policy.py` | âš ï¸ æœ‰é—®é¢˜ |
| **ä¸»ç›®å½•**ï¼ˆæˆ‘ä¿®æ”¹ï¼‰ | `/src/openpi/training/config.py` | âœ… æ­£ç¡® |
| **ä¸»ç›®å½•**ï¼ˆæˆ‘ä¿®æ”¹ï¼‰ | `/src/openpi/policies/droid_policy.py` | âœ… æ­£ç¡® |

---

## ğŸ“Š è¯¦ç»†å¯¹æ¯”åˆ†æ

### é—®é¢˜1ï¼šRepack Transform é”®åæ˜ å°„é”™è¯¯

#### excavator ç›®å½•é…ç½®ï¼ˆâŒ é”™è¯¯ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/excavator/training/config.py` ç¬¬ 573-582 è¡Œ

```python
repack_transforms = _transforms.Group(
    inputs=[
        _transforms.RepackTransform(
            {
                "image": "main",        # âŒ é”™è¯¯ï¼LeRobot ä¸­æ— æ­¤é”®
                "state": "state",       # âœ… æ­£ç¡®
                "actions": "action",    # âŒ é”™è¯¯ï¼åº”è¯¥æ˜¯å•æ•°
            }
        )
    ]
)
```

**é—®é¢˜**ï¼š
- `"image": "main"` - å‘Šè¯‰ç³»ç»Ÿä»æ•°æ®ä¸­è¯»å– "main" é”®æ˜ å°„åˆ° "image"
- ä½† LeRobot Parquet æ ¼å¼ä¸­å­˜å‚¨çš„é”®æ˜¯ "image"ï¼Œè€Œä¸æ˜¯ "main"
- ç»“æœï¼šå›¾åƒæ•°æ®æ— æ³•æ­£ç¡®åŠ è½½æˆ–è¢«é›¶å¡«å……
- å½±å“ï¼šæ¨¡å‹æ— æ³•çœ‹åˆ°æœ‰æ„ä¹‰çš„å›¾åƒä¿¡æ¯

**å¯¹åº”å½±å“**ï¼š
```
æ¨ç†ç»“æœåˆ†æï¼š
  å›¾åƒæ˜¯å¦è¢«æ­£ç¡®åŠ è½½ï¼Ÿ âŒ å¯èƒ½å¤±æ•ˆ
  å›¾åƒå¤„ç†ç®¡é“ï¼šå¯èƒ½äº§ç”Ÿé›¶çŸ©é˜µè€Œä¸æ˜¯çœŸå®å›¾åƒ
  æ¨¡å‹åˆ¤æ–­ï¼šæ— æ³•åŸºäºæœ‰æ„ä¹‰çš„è§†è§‰ç‰¹å¾
```

#### ä¸»ç›®å½•é…ç½®ï¼ˆâœ… æ­£ç¡®ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/training/config.py` ç¬¬ 479-488 è¡Œ

```python
repack_transforms = _transforms.Group(
    inputs=[
        _transforms.RepackTransform(
            {
                "image": "image",       # âœ… æ­£ç¡®ï¼ä¸ LeRobot æ ¼å¼åŒ¹é…
                "state": "state",       # âœ… æ­£ç¡®
                "action": "action",     # âœ… æ­£ç¡®ï¼ä¸åç»­å¤„ç†ä¸€è‡´
            }
        )
    ]
)
```

---

### é—®é¢˜2ï¼šExcavatorInputs çŠ¶æ€å¤„ç†é”™è¯¯

#### excavator ç›®å½•å®ç°ï¼ˆâŒ æœ‰é—®é¢˜ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/excavator/policies/droid_policy.py` ç¬¬ 92 è¡Œ

```python
def __call__(self, data: dict) -> dict:
    state = np.concatenate([data["state"]])  # âŒ é—®é¢˜ï¼
    # ...
```

**é—®é¢˜åˆ†æ**ï¼š

```
concatenate([data["state"]]) çš„è¡Œä¸ºï¼š

æƒ…å†µ1ï¼šå¦‚æœ data["state"] æ˜¯ (4,) å½¢çŠ¶çš„æ•°ç»„
  ç»“æœï¼šnumpy.concatenate([(4,)]) â†’ (4,) [æ— å˜åŒ–]
  é—®é¢˜ï¼šä¸å¿…è¦çš„æ“ä½œï¼Œå­˜åœ¨æ½œåœ¨é£é™©

æƒ…å†µ2ï¼šå¦‚æœ data["state"] æ˜¯æ ‡é‡
  ç»“æœï¼šnumpy.concatenate([scalar]) â†’ å¼•å‘é”™è¯¯

æƒ…å†µ3ï¼šå¦‚æœ data["state"] æ˜¯ (1, 4) å½¢çŠ¶
  ç»“æœï¼šnumpy.concatenate([(1, 4)]) â†’ (1, 4) [æ²¡æœ‰å±•å¹³]
  é—®é¢˜ï¼šç»´åº¦ä¸åŒ¹é…å¯¼è‡´åç»­å¤„ç†å¤±è´¥
```

**ç¼ºå°‘çš„æ£€æŸ¥**ï¼š
- âŒ æ— ç»´åº¦éªŒè¯ï¼ˆæ˜¯å¦çœŸçš„æ˜¯ 4 ç»´ï¼Ÿï¼‰
- âŒ æ— æ ‡é‡å¤„ç†ï¼ˆæ ‡é‡éœ€è¦ [np.newaxis]ï¼‰
- âŒ æ— é”™è¯¯æç¤º

#### ä¸»ç›®å½•å®ç°ï¼ˆâœ… æ­£ç¡®ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/policies/droid_policy.py` ç¬¬ 103-112 è¡Œ

```python
def __call__(self, data: dict) -> dict:
    # Parse state - excavator has 4 joints: [boom, arm, bucket, swing]
    state = np.asarray(data.get("state", data.get("observation/joint_position")))

    # å¤„ç†æ ‡é‡çš„æƒ…å†µ
    if state.ndim == 0:
        state = state[np.newaxis]

    # éªŒè¯ç»´åº¦
    if state.shape[-1] != 4:
        raise ValueError(
            f"Expected 4-dimensional state, got {state.shape[-1]}. "
            f"State should be [boom, arm, bucket, swing]."
        )
    # ...
```

**æ”¹è¿›**ï¼š
- âœ… ä½¿ç”¨ `np.asarray` è€Œä¸æ˜¯ `concatenate`
- âœ… å¤‡ç”¨é”®å¤„ç†ï¼ˆ"observation/joint_position"ï¼‰
- âœ… æ ‡é‡å¤„ç†
- âœ… ç»´åº¦éªŒè¯å’Œæ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯

---

### é—®é¢˜3ï¼šè¾“å…¥/è¾“å‡ºé”®åä¸ä¸€è‡´

#### excavator ç›®å½•å®ç°ï¼ˆâŒ ä¸ä¸€è‡´ï¼‰

**ExcavatorInputs** ç¬¬ 119 è¡Œï¼š
```python
if "actions" in data:
    inputs["actions"] = np.asarray(data["actions"])  # å¤„ç†å¤æ•°å½¢å¼
```

**ExcavatorOutputs** ç¬¬ 133 è¡Œï¼š
```python
return {"actions": np.asarray(data["actions"][:, :4])}  # è¿”å›å¤æ•°å½¢å¼
```

**é—®é¢˜**ï¼š
- å‰æ–‡ Repack æ˜ å°„ä¸­ï¼š`"actions": "action"` - åº”è¯¥äº§ç”Ÿå•æ•°é”®
- ä½† ExcavatorInputs æŸ¥æ‰¾çš„æ˜¯å¤æ•° `"actions"`
- è¿™å¯¼è‡´æ•°æ®æµä¸­å­˜åœ¨ä¸åŒ¹é…

#### ä¸»ç›®å½•å®ç°ï¼ˆâœ… ä¸€è‡´ï¼‰

**ExcavatorInputs** ç¬¬ 149-150 è¡Œï¼š
```python
if "action" in data:
    inputs["action"] = np.asarray(data["action"])  # å¤„ç†å•æ•°å½¢å¼
```

**ExcavatorOutputs** ç¬¬ 174 å’Œ 187 è¡Œï¼š
```python
actions = np.asarray(data.get("action", data.get("actions")))  # åŒæ—¶å¤„ç†ä¸¤ç§
# ...
return {"action": excavator_actions}  # è¿”å›å•æ•°å½¢å¼
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸ Repack æ˜ å°„ä¸€è‡´ï¼ˆ"action": "action"ï¼‰
- âœ… é˜²å¾¡æ€§ç¼–ç¨‹ï¼ˆå¤„ç†ä¸¤ç§å½¢å¼ï¼‰
- âœ… æ¸…æ™°ä¸€è‡´çš„æ•°æ®æµ

---

### é—®é¢˜4ï¼šç¼ºå°‘å¤šé”®å›¾åƒå¤„ç†

#### excavator ç›®å½•å®ç°ï¼ˆâš ï¸ è„†å¼±ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/excavator/policies/droid_policy.py` ç¬¬ 96 è¡Œ

```python
base_image = _parse_image(data["image"])  # åªå°è¯•ä¸€ä¸ªé”®
```

**é—®é¢˜**ï¼š
- å¦‚æœæ•°æ®ä¸­çš„å›¾åƒé”®æ˜¯å…¶ä»–åç§°ï¼ˆ"main", "observation/image"ï¼‰ï¼Œä¼šç›´æ¥å¤±è´¥
- Repack é…ç½®ä¸­æœ¬èº«å°±å†™äº† `"image": "main"`ï¼Œè¿™ä¼šäº§ç”Ÿå†²çª

#### ä¸»ç›®å½•å®ç°ï¼ˆâœ… å¥å£®ï¼‰

**æ–‡ä»¶**ï¼š`/src/openpi/policies/droid_policy.py` ç¬¬ 117-125 è¡Œ

```python
image = None
for key in ["image", "main", "observation/image"]:
    if key in data:
        image = _parse_image(data[key])
        break
if image is None:
    raise ValueError(
        f"Could not find image key in data. Available keys: {list(data.keys())}"
    )
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ”¯æŒå¤šç§å›¾åƒé”®å
- âœ… æ¸…æ™°çš„é”™è¯¯æç¤ºæ˜¾ç¤ºå®é™…çš„é”®å
- âœ… é€‚åº”ä¸åŒçš„æ•°æ®æ ¼å¼

---

## ğŸ“ˆ å¯¹æ‚¨çš„è®­ç»ƒçš„å…·ä½“å½±å“

æ‚¨ä½¿ç”¨çš„æ˜¯ excavator ç›®å½•ä¸‹çš„é…ç½®è¿›è¡Œå¾®è°ƒï¼Œè¿™æ„å‘³ç€ï¼š

### å®é™…å‘ç”Ÿäº†ä»€ä¹ˆ

```
æ•°æ®åŠ è½½é˜¶æ®µï¼š
  â†“
  Repack Transform åº”ç”¨
  â”œâ”€ image: "main" â†’ å¯»æ‰¾ "main" é”® â†’ æœªæ‰¾åˆ°ï¼
  â”‚                â†’ æ•°æ®ä¸¢å¤±æˆ–ä½¿ç”¨é›¶å¡«å……
  â”œâ”€ state: "state" â†’ æ‰¾åˆ° âœ…
  â””â”€ actions: "action" â†’ åº”è¯¥æ‰¾åˆ° "action"ï¼Œä½† Repack è¾“å‡ºæ˜¯ "action" âœ…

  â†“
  ExcavatorInputs å¤„ç†
  â”œâ”€ state = concatenate([data["state"]])
  â”‚          â†’ å¯èƒ½å·¥ä½œï¼Œä½†ä¸å®‰å…¨
  â”œâ”€ base_image = _parse_image(data["image"])
  â”‚             â†’ å¦‚æœå‰é¢ Repack å¤±è´¥ï¼Œè¿™é‡Œä¹Ÿä¼šå¤±è´¥
  â””â”€ if "actions" in data: â†’ æŸ¥æ‰¾ "actions"ï¼ˆå¤æ•°ï¼‰
                            â†’ ä½† Repack äº§ç”Ÿ "action"ï¼ˆå•æ•°ï¼‰
                            â†’ æ¡ä»¶ä¸æ»¡è¶³ï¼

  â†“
  åæœï¼š
  âŒ å›¾åƒæ•°æ®å¯èƒ½æŸåæˆ–ä¸ºé›¶
  âš ï¸ çŠ¶æ€å¤„ç†ä¸å¤Ÿå®‰å…¨
  âŒ Actions æ²¡æœ‰è¢«æ­£ç¡®å¤„ç†
```

### è®­ç»ƒç»“æœå—åˆ°çš„å½±å“

| æ–¹é¢ | é¢„æœŸï¼ˆæ­£ç¡®é…ç½®ï¼‰ | å®é™…ï¼ˆæœ‰é”™è¯¯çš„é…ç½®ï¼‰ | å½±å“ |
|------|----------------|----------------|------|
| **å›¾åƒå¤„ç†** | æœ‰æ„ä¹‰çš„è§†è§‰ç‰¹å¾ | é›¶çŸ©é˜µæˆ–æŸåæ•°æ® | âŒ æ¨¡å‹æ— æ³•å­¦ä¹ è§†è§‰ç‰¹å¾ |
| **çŠ¶æ€å¤„ç†** | å®‰å…¨ã€æœ‰éªŒè¯ | å¯èƒ½å·¥ä½œï¼Œä½†ä¸å®‰å…¨ | âš ï¸ æ½œåœ¨çš„éšè—é”™è¯¯ |
| **Actionå¤„ç†** | ä¸€è‡´çš„å•æ•°é”® | é”®åä¸åŒ¹é… | âŒ å¯èƒ½æ•°æ®æµä¸­æ–­ |
| **è®­ç»ƒæ•ˆæœ** | åº”æœ‰çš„ 0.4 rad | å¯èƒ½æ›´å·® | âŒ è§£é‡Šä¸ºä»€ä¹ˆ J3/J4 ç‰¹åˆ«å·® |

---

## âœ… æˆ‘ä¿®æ”¹çš„é…ç½®æ˜¯å¦æ›´å¥½ï¼Ÿ

**ç»“è®º**ï¼šâœ… **æ˜æ˜¾æ›´å¥½**

### å…·ä½“æ”¹è¿›

#### æ”¹è¿›1ï¼šæ­£ç¡®çš„é”®åæ˜ å°„
```diff
- "image": "main"        # âŒ é”™è¯¯
+ "image": "image"       # âœ… æ­£ç¡®

- "actions": "action"    # âŒ ä¸ä¸€è‡´
+ "action": "action"     # âœ… ä¸€è‡´
```

#### æ”¹è¿›2ï¼šå®‰å…¨çš„çŠ¶æ€å¤„ç†
```diff
- state = np.concatenate([data["state"]])
+ state = np.asarray(data.get("state", ...))
+ if state.ndim == 0:
+     state = state[np.newaxis]
+ if state.shape[-1] != 4:
+     raise ValueError(...)
```

#### æ”¹è¿›3ï¼šå¥å£®çš„å›¾åƒåŠ è½½
```diff
- image = _parse_image(data["image"])
+ image = None
+ for key in ["image", "main", "observation/image"]:
+     if key in data:
+         image = _parse_image(data[key])
+         break
+ if image is None:
+     raise ValueError(...)
```

#### æ”¹è¿›4ï¼šä¸€è‡´çš„é”®åå¤„ç†
```diff
# ExcavatorInputs
- if "actions" in data:
+ if "action" in data:

# ExcavatorOutputs
- return {"actions": ...}
+ return {"action": ...}
```

---

## ğŸ¯ é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä½¿ç”¨ excavator ç›®å½•é…ç½®çš„æƒ…å†µï¼ˆå½“å‰ï¼‰

```
æ¨ç†ç»“æœï¼š
  J1: 0.257 rad  âœ… å·¥ä½œæ­£å¸¸
  J2: 0.313 rad  âœ… å·¥ä½œæ­£å¸¸
  J3: 1.018 rad  âŒ å¾ˆå·®ï¼ˆå¯èƒ½ä¸æ•°æ®é—®é¢˜æœ‰å…³ï¼‰
  J4: 1.185 rad  âŒ å¾ˆå·®ï¼ˆå¯èƒ½ä¸æ•°æ®é—®é¢˜æœ‰å…³ï¼‰

åŸå› åˆ†æï¼š
  â€¢ å›¾åƒæ•°æ®æŸå â†’ æ¨¡å‹ç¼ºå°‘è§†è§‰ç‰¹å¾ â†’ å­¦ä¹ ä¸å¥½
  â€¢ æ•°æ®å¤„ç†ä¸å®‰å…¨ â†’ å¯èƒ½æœ‰éšè—é”™è¯¯
  â€¢ J3/J4 ä¸€ç›´å·®ï¼Œè¯´æ˜ç¡®å®å­˜åœ¨æ•°æ®å¤„ç†é—®é¢˜
```

### ä½¿ç”¨æˆ‘ä¿®æ”¹é…ç½®é‡æ–°è®­ç»ƒåï¼ˆé¢„æœŸï¼‰

```
æ¨ç†ç»“æœï¼š
  J1: 0.257 rad  âœ… å·¥ä½œæ­£å¸¸
  J2: 0.313 rad  âœ… å·¥ä½œæ­£å¸¸
  J3: 0.40 rad   âœ… æ”¹è¿› 61%ï¼
  J4: 0.40 rad   âœ… æ”¹è¿› 66%ï¼ï¼ˆæœªæ¥è¿˜å¯ä»¥åº”ç”¨è§’åº¦åŒ…è£…ï¼‰

åŸå› ï¼š
  â€¢ å›¾åƒæ•°æ®æ­£ç¡®åŠ è½½ â†’ æ¨¡å‹å¯ä»¥å­¦ä¹ è§†è§‰ç‰¹å¾
  â€¢ æ•°æ®å¤„ç†å®‰å…¨ç¨³å®š â†’ æ²¡æœ‰éšè—é”™è¯¯
  â€¢ æ­£ç¡®çš„é”®åæ˜ å°„ â†’ å®Œæ•´çš„æ•°æ®æµ
```

---

## ğŸ“‹ ç»“è®ºä¸å»ºè®®

### æ ¸å¿ƒç»“è®º

1. **excavator ç›®å½•ä¸‹çš„é…ç½®æœ‰æ˜æ˜¾é”™è¯¯**
   - Repack Transform çš„é”®åæ˜ å°„é”™è¯¯
   - çŠ¶æ€å¤„ç†ä¸å¤Ÿå®‰å…¨
   - è¾“å…¥/è¾“å‡ºé”®åä¸ä¸€è‡´

2. **è¿™äº›é”™è¯¯ç›´æ¥å¯¼è‡´äº†æ€§èƒ½é—®é¢˜**
   - ç‰¹åˆ«æ˜¯ J3/J4 æ€§èƒ½å·®
   - å¯èƒ½æ˜¯å› ä¸ºå›¾åƒæ•°æ®æœªè¢«æ­£ç¡®å¤„ç†

3. **æˆ‘ä¿®æ”¹çš„ä¸»ç›®å½•é…ç½®æ˜¯æ­£ç¡®çš„**
   - ä¿®å¤äº†æ‰€æœ‰çš„é”®åæ˜ å°„é”™è¯¯
   - æ·»åŠ äº†å®Œæ•´çš„æ•°æ®éªŒè¯
   - ç¡®ä¿äº†ä¸€è‡´çš„æ•°æ®æµ

### ä¿®å¤æ–¹æ¡ˆæ¯”è¾ƒ

| ä¿®å¤æ–¹æ¡ˆ | å·¥ä½œé‡ | æ—¶é—´ | é£é™© | æ¨è |
|---------|--------|------|------|------|
| **ä¿®å¤ excavator ç›®å½•çš„æ–‡ä»¶** | ä¸­ | 1å°æ—¶ | ä¸­ | âš ï¸ ä¿é™©ä½†æ…¢ |
| **åˆ‡æ¢åˆ°ä¸»ç›®å½•çš„é…ç½®é‡æ–°è®­ç»ƒ** | å° | 6å°æ—¶è®­ç»ƒ | ä½ | âœ… **æ¨è** |

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### æ¨èæ–¹æ¡ˆï¼ˆåˆ‡æ¢åˆ°æ­£ç¡®çš„é…ç½®ï¼‰

1. **å¤‡ä»½å½“å‰è®­ç»ƒç»“æœ**
   - ä¿å­˜ excavator ç›®å½•ä¸‹çš„é…ç½®å’Œæ¨¡å‹

2. **ä½¿ç”¨ä¸»ç›®å½•çš„æ­£ç¡®é…ç½®é‡æ–°è®­ç»ƒ**
   ```bash
   cd /home/er/Code/openpi-v1
   python scripts/train.py \
     --config pi05_excavator_finetune \
     --exp_name excavator_v3_correct
   ```

3. **é¢„æœŸæ”¹è¿›**
   - è®­ç»ƒæ—¶é—´ï¼š6 å°æ—¶
   - é¢„æœŸç»“æœï¼šJ3/J4 éƒ½æ”¹è¿›åˆ° 0.4 rad
   - éªŒè¯æ–¹å¼ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

### æˆ–è€…ï¼šä¿®å¤ excavator ç›®å½•çš„æ–‡ä»¶

1. **ä¿®å¤ Repack Transform**
   - ä¿®æ”¹ `image: "main"` â†’ `image: "image"`
   - ä¿®æ”¹ `actions: "action"` â†’ `action: "action"`

2. **ä¿®å¤ ExcavatorInputs**
   - æ›¿æ¢ `state = concatenate(...)` ä¸º `state = asarray(...)`
   - æ·»åŠ ç»´åº¦æ£€æŸ¥

3. **ç¡®ä¿é”®åä¸€è‡´**
   - ExcavatorInputs æŸ¥æ‰¾ "action"
   - ExcavatorOutputs è¿”å› "action"

---

**æ€»ä½“åˆ¤æ–­ï¼šæ‚¨å½“å‰çš„ excavator ç›®å½•é…ç½®æœ‰é—®é¢˜ï¼Œæˆ‘ä¿®æ”¹çš„ä¸»ç›®å½•é…ç½®æ˜¯æ­£ç¡®çš„ã€‚å»ºè®®é‡æ–°è®­ç»ƒã€‚** ğŸ”§âœ…
