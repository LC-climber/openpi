# ðŸ› ï¸ é…ç½®æ–‡ä»¶ä¿®å¤å®žæ–½æŒ‡å—ä¸Žæ“ä½œæ­¥éª¤

## ðŸ“‹ å¿«é€Ÿå†³ç­–è¡¨

### æ‚¨éœ€è¦åšå‡ºçš„é€‰æ‹©

| é€‰é¡¹ | æ—¶é—´ | å·¥ä½œé‡ | æŽ¨è | è¯´æ˜Ž |
|------|------|--------|------|------|
| **æ–¹æ¡ˆAï¼šé‡æ–°è®­ç»ƒï¼ˆæŽ¨èï¼‰** | 6å°æ—¶ | å° | âœ… **æŽ¨è** | ä½¿ç”¨æ­£ç¡®çš„ä¸»ç›®å½•é…ç½®ï¼Œå®Œå…¨è§£å†³é—®é¢˜ |
| **æ–¹æ¡ˆBï¼šä¿®å¤ excavator æ–‡ä»¶** | 1å°æ—¶+6å°æ—¶è®­ç»ƒ | ä¸­ | âš ï¸ å¯é€‰ | ä¿®å¤ excavator ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç„¶åŽé‡æ–°è®­ç»ƒ |
| **æ–¹æ¡ˆCï¼šåªä¿®å¤ä¸è®­ç»ƒ** | 1å°æ—¶ | å° | âŒ ä¸æŽ¨è | ä¿®å¤æ–‡ä»¶åŽç»§ç»­ç”¨æ—§æ¨¡åž‹ï¼Œæ•ˆæžœæœ‰é™ |

---

## ðŸŽ¯ æ–¹æ¡ˆAï¼šé‡æ–°è®­ç»ƒï¼ˆæŽ¨èæ–¹æ¡ˆï¼‰

### æ­¥éª¤1ï¼šéªŒè¯ä¸»ç›®å½•é…ç½®æ˜¯å¦æ­£ç¡®

```bash
# æ£€æŸ¥ config.py ä¸­çš„ LeRobotExcavatorDataConfig
grep -A 20 "class LeRobotExcavatorDataConfig" /home/er/Code/openpi-v1/openpi/src/openpi/training/config.py

# é¢„æœŸè¾“å‡ºåº”è¯¥åŒ…å«ï¼š
# "image": "image"
# "state": "state"
# "action": "action"
```

### æ­¥éª¤2ï¼šéªŒè¯ droid_policy.py ä¸­çš„ç±»

```bash
# æ£€æŸ¥ ExcavatorInputs æ˜¯å¦å­˜åœ¨
grep -A 5 "class ExcavatorInputs" /home/er/Code/openpi-v1/openpi/src/openpi/policies/droid_policy.py

# æ£€æŸ¥çŠ¶æ€å¤„ç†æ˜¯å¦æ­£ç¡®
grep -A 10 "def __call__" /home/er/Code/openpi-v1/openpi/src/openpi/policies/droid_policy.py | head -20
```

### æ­¥éª¤3ï¼šå‡†å¤‡é‡æ–°è®­ç»ƒ

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/er/Code/openpi-v1

# é€‰é¡¹1ï¼šä½¿ç”¨æ­£ç¡®çš„é…ç½®å¯åŠ¨è®­ç»ƒ
python scripts/train.py \
  --config pi05_excavator_finetune \
  --exp_name excavator_v3_fixed \
  --overwrite

# æˆ–è€…ä½¿ç”¨ tyro çš„ CLI æ–¹å¼
# python scripts/train.py --help | grep excavator
```

### æ­¥éª¤4ï¼šç›‘æŽ§è®­ç»ƒè¿‡ç¨‹

```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f checkpoints/pi05_excavator_finetune/excavator_v3_fixed/log.txt

# æˆ–è€…é€šè¿‡ wandb ç›‘æŽ§
# æ‰“å¼€æµè§ˆå™¨è®¿é—® https://wandb.ai/your-project/openpi
```

### æ­¥éª¤5ï¼šéªŒè¯è®­ç»ƒç»“æžœ

```bash
# è®­ç»ƒå®ŒæˆåŽï¼Œè¿è¡ŒæŽ¨ç†
cd /home/er/Code/openpi-v1/openpi/src/openpi/excavator
python test_infer_v3.py

# æ£€æŸ¥ç»“æžœ
cat /home/er/Code/openpi-v1/output_v3/v3_stats.json

# è¿è¡Œè¯Šæ–­
python angle_wrapping_diagnosis.py
python quick_diagnosis.py
```

### é¢„æœŸç»“æžœ

```json
{
  "å…³èŠ‚": ["å¤§è‡‚ (Boom)", "å°è‡‚ (Arm)", "é“²æ–— (Bucket)", "å›žè½¬ (Swing)"],
  "MAE": [0.257, 0.313, 0.40, 0.40],
  "æ”¹è¿›": [0, 0, 61%, 66%]
}
```

---

## ðŸ”§ æ–¹æ¡ˆBï¼šä¿®å¤ excavator ç›®å½•æ–‡ä»¶

å¦‚æžœæ‚¨å¸Œæœ›åœ¨ excavator ç›®å½•ä¸‹å°±åœ°ä¿®å¤ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ï¼š

### æ­¥éª¤1ï¼šä¿®å¤ config.py ä¸­çš„ Repack Transform

**æ–‡ä»¶**ï¼š`/home/er/Code/openpi-v1/openpi/src/openpi/excavator/training/config.py`

**ä½ç½®**ï¼šç¬¬ 573-584 è¡Œ

**ä¿®æ”¹å‰**ï¼š
```python
repack_transforms = _transforms.Group(
    inputs=[
        _transforms.RepackTransform(
            {
                "image": "main",
                "state": "state",
                "actions": "action",
            }
        )
    ]
)
```

**ä¿®æ”¹åŽ**ï¼š
```python
repack_transforms = _transforms.Group(
    inputs=[
        _transforms.RepackTransform(
            {
                "image": "image",       # ä¿®æ”¹ï¼šmain â†’ image
                "state": "state",
                "action": "action",     # ä¿®æ”¹ï¼šactions â†’ action
            }
        )
    ]
)
```

### æ­¥éª¤2ï¼šä¿®å¤ droid_policy.py ä¸­çš„ ExcavatorInputs

**æ–‡ä»¶**ï¼š`/home/er/Code/openpi-v1/openpi/src/openpi/excavator/policies/droid_policy.py`

**ä½ç½®**ï¼šç¬¬ 86-127 è¡Œ

**å®Œæ•´æ›¿æ¢**ï¼š

```python
@dataclasses.dataclass(frozen=True)
class ExcavatorInputs(transforms.DataTransformFn):
    """
    Transform for excavator state -> action prediction.

    Input data format (from LeRobot):
    - image: Camera observation (H, W, C) uint8
    - state: Joint positions [boom, arm, bucket, swing] (4,) float32
    - action: Joint actions [boom, arm, bucket, swing] (4,) float32

    Output format (for model):
    - state: Joint positions (4,) float32
    - image: Dict with camera views (for tokenization)
    - image_mask: Dict with camera availability masks
    - action: (optional) Actions for training
    """

    model_type: _model.ModelType

    def __call__(self, data: dict) -> dict:
        # Parse state - excavator has 4 joints: [boom, arm, bucket, swing]
        state = np.asarray(data.get("state", data.get("observation/joint_position")))
        if state.ndim == 0:
            state = state[np.newaxis]
        if state.shape[-1] != 4:
            raise ValueError(
                f"Expected 4-dimensional state, got {state.shape[-1]}. "
                f"State should be [boom, arm, bucket, swing]."
            )

        # Parse image - excavator uses single camera
        # Handle both (C, H, W) and (H, W, C) formats
        # Try multiple possible keys: "image", "main", "observation/image"
        image = None
        for key in ["image", "main", "observation/image"]:
            if key in data:
                image = _parse_image(data[key])
                break
        if image is None:
            raise ValueError(
                f"Could not find image key in data. Available keys: {list(data.keys())}"
            )

        # For excavator, we only have one camera (not like DROID's 2+ cameras)
        # But we need to match the Pi0/Pi0.5 input format which expects 3 cameras
        match self.model_type:
            case _model.ModelType.PI0 | _model.ModelType.PI05:
                # Pad to 3 cameras to match base model
                names = ("base_0_rgb", "left_wrist_0_rgb", "right_wrist_0_rgb")
                images = (image, np.zeros_like(image), np.zeros_like(image))
                image_masks = (np.True_, np.False_, np.False_)  # Only 1st camera available
            case _model.ModelType.PI0_FAST:
                names = ("base_0_rgb", "base_1_rgb", "wrist_0_rgb")
                images = (image, np.zeros_like(image), np.zeros_like(image))
                image_masks = (np.True_, np.True_, np.True_)
            case _:
                raise ValueError(f"Unsupported model type: {self.model_type}")

        inputs = {
            "state": state,
            "image": dict(zip(names, images, strict=True)),
            "image_mask": dict(zip(names, image_masks, strict=True)),
        }

        # Include actions for training
        if "action" in data:
            inputs["action"] = np.asarray(data["action"])

        # Include prompt if provided
        if "prompt" in data:
            prompt = data["prompt"]
            if isinstance(prompt, bytes):
                prompt = prompt.decode("utf-8")
            inputs["prompt"] = prompt

        return inputs
```

### æ­¥éª¤3ï¼šä¿®å¤ droid_policy.py ä¸­çš„ ExcavatorOutputs

**æ–‡ä»¶**ï¼š`/home/er/Code/openpi-v1/openpi/src/openpi/excavator/policies/droid_policy.py`

**ä½ç½®**ï¼šç¬¬ 129-133 è¡Œ

**å®Œæ•´æ›¿æ¢**ï¼š

```python
@dataclasses.dataclass(frozen=True)
class ExcavatorOutputs(transforms.DataTransformFn):
    """
    Transform excavator model output to action space.

    The model outputs 32-dim actions (Pi0.5 standard), but excavator only needs 4.
    This extracts and validates the first 4 dimensions.

    Output dimensions map to: [boom, arm, bucket, swing]
    """

    def __call__(self, data: dict) -> dict:
        actions = np.asarray(data.get("action", data.get("actions")))

        # Extract first 4 dimensions for excavator joints
        # Validate that we have at least 4 dims
        if actions.shape[-1] < 4:
            raise ValueError(
                f"Model output has {actions.shape[-1]} dims, need at least 4 "
                f"for [boom, arm, bucket, swing]."
            )

        # Return only the 4 excavator dimensions
        excavator_actions = actions[..., :4]

        return {"action": excavator_actions}
```

### æ­¥éª¤4ï¼šéªŒè¯ä¿®æ”¹

```bash
# éªŒè¯ Python è¯­æ³•
python3 -m py_compile /home/er/Code/openpi-v1/openpi/src/openpi/excavator/policies/droid_policy.py
python3 -m py_compile /home/er/Code/openpi-v1/openpi/src/openpi/excavator/training/config.py

# å¦‚æžœæ²¡æœ‰é”™è¯¯ï¼Œè¾“å‡ºå°†ä¸ºç©º
# å¦‚æžœæœ‰é”™è¯¯ï¼Œä¼šæ˜¾ç¤ºå…·ä½“çš„è¯­æ³•é—®é¢˜
```

### æ­¥éª¤5ï¼šé‡æ–°è®­ç»ƒ

ä¿®å¤åŽä½¿ç”¨ excavator ç›®å½•çš„é…ç½®é‡æ–°è®­ç»ƒï¼š

```bash
cd /home/er/Code/openpi-v1

# ä½¿ç”¨ excavator ç›®å½•çš„é…ç½®
python scripts/train.py \
  --config pi05_excavator_finetune \
  --exp_name excavator_v3_fixed_excavator_dir
```

---

## ðŸ“Š ä¸¤ç§æ–¹æ¡ˆçš„å¯¹æ¯”

### æ–¹æ¡ˆ A vs æ–¹æ¡ˆ B

| å¯¹æ¯”é¡¹ | æ–¹æ¡ˆA | æ–¹æ¡ˆB |
|--------|------|------|
| **ä¼˜ç‚¹** | ä½¿ç”¨å·²éªŒè¯çš„æ­£ç¡®é…ç½® | ä¿®å¤ excavator ç›®å½•ä¸‹çš„é—®é¢˜ |
| **é£Žé™©** | æ—  | ä¿®æ”¹æ—¶å¯èƒ½å‡ºçŽ°æ–°é”™è¯¯ |
| **å¯ç»´æŠ¤æ€§** | å¥½ï¼ˆä¸»ç›®å½•ä»£ç ï¼‰ | å·®ï¼ˆä¸¤å¥—é…ç½®å¹¶å­˜ï¼‰ |
| **æ–‡æ¡£** | å®Œæ•´ | éœ€è¦è¡¥å…… |
| **æŽ¨è** | âœ… | âš ï¸ |

---

## ðŸ”„ å®Œæ•´å·¥ä½œæµç¨‹ï¼ˆæŽ¨èæ–¹æ¡ˆAï¼‰

```
1. éªŒè¯é…ç½®æ­£ç¡®æ€§ï¼ˆ5åˆ†é’Ÿï¼‰
   â†“
2. å¯åŠ¨é‡æ–°è®­ç»ƒï¼ˆ6å°æ—¶ï¼‰
   â†“
3. è®­ç»ƒå®ŒæˆåŽéªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰
   â†“
4. åº”ç”¨è§’åº¦åŒ…è£…ä¿®å¤ï¼ˆ5åˆ†é’Ÿï¼‰
   â†“
5. è¿è¡Œè¯Šæ–­ç¡®è®¤æ”¹è¿›ï¼ˆ5åˆ†é’Ÿï¼‰
   â†“
6. æ›´æ–°æ–‡æ¡£è®°å½•ï¼ˆ10åˆ†é’Ÿï¼‰
   â†“
å®Œæˆï¼æ‰€æœ‰é—®é¢˜è§£å†³
```

---

## ðŸ“ž å¸¸è§é—®é¢˜

### Q1ï¼šæˆ‘åº”è¯¥é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ

**A**ï¼šå»ºè®®é€‰æ‹©æ–¹æ¡ˆAï¼ˆé‡æ–°è®­ç»ƒï¼‰ï¼Œå› ä¸ºï¼š
- ä½¿ç”¨å·²éªŒè¯çš„æ­£ç¡®é…ç½®
- æ²¡æœ‰ä¿®æ”¹ä»£ç çš„é£Žé™©
- ä¿®å¤ excavator ç›®å½•ä¸‹çš„æ–‡ä»¶åŽä»éœ€é‡æ–°è®­ç»ƒ
- æœ€ç»ˆéƒ½è¦è®­ç»ƒ 6 å°æ—¶ï¼Œä¸å¦‚ç›´æŽ¥ç”¨æ­£ç¡®é…ç½®

### Q2ï¼šé‡æ–°è®­ç»ƒä¼šä¸¢å¤±ä¹‹å‰çš„æ¨¡åž‹å—ï¼Ÿ

**A**ï¼šä¸ä¼šã€‚ä¹‹å‰çš„æ¨¡åž‹ä¼šä¿å­˜åœ¨ä¸åŒçš„å®žéªŒåç§°ä¸‹ï¼š
- æ—§æ¨¡åž‹ï¼š`checkpoints/pi05_excavator_finetune/[old_exp_name]`
- æ–°æ¨¡åž‹ï¼š`checkpoints/pi05_excavator_finetune/excavator_v3_fixed`
- æ‚¨å¯ä»¥å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æ€§èƒ½

### Q3ï¼šå¦‚ä½•åœ¨è®­ç»ƒä¸­é€”åœæ­¢ï¼Ÿ

**A**ï¼šæŒ‰ `Ctrl+C` å³å¯ã€‚è®­ç»ƒæ•°æ®ä¼šä¿å­˜ï¼Œæ‚¨å¯ä»¥ç”¨ `--resume` å‚æ•°ç»§ç»­ã€‚

### Q4ï¼šä¿®å¤ excavator æ–‡ä»¶æœ‰ä»€ä¹ˆé£Žé™©ï¼Ÿ

**A**ï¼š
- å¦‚æžœä¿®æ”¹æœ‰è¯­æ³•é”™è¯¯ï¼Œä¼šå¯¼è‡´è®­ç»ƒå¤±è´¥
- å»ºè®®ç”¨ `python3 -m py_compile` éªŒè¯
- ä¿®æ”¹å‰å»ºè®®å¤‡ä»½åŽŸæ–‡ä»¶ï¼š`cp [file] [file].backup`

### Q5ï¼šæ–°è®­ç»ƒçš„æ¨¡åž‹ä¼šæ¯”æ—§çš„å¥½å¤šå°‘ï¼Ÿ

**A**ï¼š
- J1/J2ï¼šæ— å˜åŒ–ï¼ˆå·²ç»å¾ˆå¥½ï¼‰
- J3ï¼šé¢„æœŸæ”¹è¿› 61%ï¼ˆ1.018 â†’ 0.40 radï¼‰
- J4ï¼šé¢„æœŸæ”¹è¿› 66%ï¼ˆ1.185 â†’ 0.40 radï¼‰
- å†åº”ç”¨è§’åº¦åŒ…è£…ï¼šJ4 å¯è¿›ä¸€æ­¥æ”¹è¿›

---

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] å·²é˜…è¯»å¹¶ç†è§£é…ç½®æ–‡ä»¶å¯¹æ¯”åˆ†æž
- [ ] å·²å†³å®šé€‰æ‹©æ–¹æ¡ˆAï¼ˆé‡æ–°è®­ç»ƒï¼‰æˆ–æ–¹æ¡ˆBï¼ˆä¿®å¤æ–‡ä»¶ï¼‰
- [ ] å¤‡ä»½äº†å½“å‰çš„æ¨¡åž‹å’Œå®žéªŒæ•°æ®
- [ ] ç¡®è®¤æœ‰è¶³å¤Ÿçš„ GPU æ˜¾å­˜ï¼ˆè‡³å°‘ 24GBï¼‰
- [ ] ç¡®è®¤æœ‰è¶³å¤Ÿçš„ç¡¬ç›˜ç©ºé—´ï¼ˆè‡³å°‘ 50GBï¼‰
- [ ] ç¡®è®¤ç½‘ç»œè¿žæŽ¥ç¨³å®šï¼ˆè®­ç»ƒéœ€è¦ 6 å°æ—¶ï¼‰

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿé€‰æ‹©æ‚¨çš„æ–¹æ¡ˆå¹¶å¼€å§‹è¡ŒåŠ¨ï¼** ðŸš€
