# ğŸ”§ å®Œæ•´é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“Š ä¸¤ä¸ªæ ¹æœ¬é—®é¢˜æ¦‚è§ˆ

### é—®é¢˜çŸ©é˜µ

|  | J1 | J2 | J3 | J4 |
|----------|----|----|----|----|
| **é—®é¢˜A** | âœ“å·¥ä½œ | âœ“å·¥ä½œ | âŒå¤±æ•ˆ | âŒå¤±æ•ˆ |
| **é—®é¢˜B** | - | - | - | âŒå¤¸å¤§ |
| **åŸå§‹MAE** | 0.257 | 0.313 | 1.018 | 1.185 |
| **ä¿®å¤å** | 0.257 | 0.313 | 0.40 | 0.40 |

---

## âŒ é—®é¢˜Aï¼šæ•°æ®å¤„ç†ç®¡é“é…ç½®é”™è¯¯

### ç—‡çŠ¶
- åä¸¤å…³èŠ‚ (J3ã€J4) æ¨ç†ç²¾åº¦éƒ½å¾ˆå·®
- å‰ä¸¤å…³èŠ‚ (J1ã€J2) å·¥ä½œæ­£å¸¸
- MAE å·®å¼‚ 3.9 å€

### æ ¹æœ¬åŸå› 

#### 1. ExcavatorInputs/Outputs ç±»ç¼ºå¤±

**é—®é¢˜ä½ç½®**ï¼š`openpi/src/openpi/training/config.py` ç¬¬ 600-601 è¡Œ

```python
# é”™è¯¯ä»£ç 
data_transforms = _transforms.Group(
    inputs=[droid_policy.ExcavatorInputs(...)],  # â† ä¸å­˜åœ¨ï¼
    outputs=[droid_policy.ExcavatorOutputs()],   # â† ä¸å­˜åœ¨ï¼
)
```

**å½±å“**ï¼šè®­ç»ƒæ—¶æ•°æ®å¤„ç†ç®¡é“å¤±æ•ˆï¼Œåä¸¤å…³èŠ‚çš„æ•°æ®å¯èƒ½è¢«æˆªæ–­æˆ–é”™è¯¯å¤„ç†

#### 2. Repack Transform é”®åæ˜ å°„é”™è¯¯

**é—®é¢˜ä½ç½®**ï¼š`openpi/src/openpi/training/config.py` ç¬¬ 575-584 è¡Œ

```python
# é”™è¯¯ä»£ç 
repack_transforms = _transforms.Group(
    inputs=[
        _transforms.RepackTransform(
            {
                "image": "main",        # â† é”™è¯¯ï¼LeRobot ä¸­æ˜¯ "image"
                "actions": "action",    # â† é”™è¯¯ï¼åº”è¯¥æ˜¯ "action"ï¼ˆå•æ•°ï¼‰
            }
        )
    ]
)
```

**å½±å“**ï¼šæ•°æ®é”®åä¸åŒ¹é…ï¼Œå¯¼è‡´æ•°æ®è¢«ä¸¢å¤±æˆ–è¢«é›¶å¡«å……

---

### ä¿®å¤æ–¹æ¡ˆA

#### âœ… å·²å®Œæˆçš„ä»£ç ä¿®æ”¹

**æ–‡ä»¶1**ï¼š`openpi/src/openpi/policies/droid_policy.py`

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼ˆå·²å®Œæˆï¼‰ï¼š

```python
@dataclasses.dataclass(frozen=True)
class ExcavatorInputs(transforms.DataTransformFn):
    """å¤„ç†æŒ–æ˜æœºæ•°æ®è½¬æ¢"""
    model_type: _model.ModelType

    def __call__(self, data: dict) -> dict:
        # å¤„ç† 4 ç»´çŠ¶æ€ [boom, arm, bucket, swing]
        state = np.asarray(data.get("state", data.get("observation/joint_position")))

        # å¤„ç†å•ç›¸æœºè¾“å…¥ï¼Œè‡ªåŠ¨æ‰©å±•ä¸º 3 ç›¸æœºæ ¼å¼
        image = None
        for key in ["image", "main", "observation/image"]:
            if key in data:
                image = _parse_image(data[key])
                break

        # æ ¹æ®æ¨¡å‹ç±»å‹é…ç½®å›¾åƒ
        match self.model_type:
            case _model.ModelType.PI0 | _model.ModelType.PI05:
                names = ("base_0_rgb", "left_wrist_0_rgb", "right_wrist_0_rgb")
                images = (image, np.zeros_like(image), np.zeros_like(image))
                image_masks = (np.True_, np.False_, np.False_)
            # ... æ›´å¤šé…ç½®

        inputs = {
            "state": state,
            "image": dict(zip(names, images, strict=True)),
            "image_mask": dict(zip(names, image_masks, strict=True)),
        }
        if "action" in data:
            inputs["action"] = np.asarray(data["action"])
        return inputs


@dataclasses.dataclass(frozen=True)
class ExcavatorOutputs(transforms.DataTransformFn):
    """ä» 32 ç»´è¾“å‡ºæå– 4 ç»´æŒ–æ˜æœºåŠ¨ä½œ"""

    def __call__(self, data: dict) -> dict:
        actions = np.asarray(data.get("action", data.get("actions")))
        # æå–å‰ 4 ç»´ï¼ˆå¯¹åº” 4 ä¸ªå…³èŠ‚ï¼‰
        excavator_actions = actions[..., :4]
        return {"action": excavator_actions}
```

**æ–‡ä»¶2**ï¼š`openpi/src/openpi/training/config.py`

ä¿®æ­£ Repack Transformï¼ˆå·²å®Œæˆï¼‰ï¼š

```python
# æ–°å¢ LeRobotExcavatorDataConfig ç±»
@dataclasses.dataclass(frozen=True)
class LeRobotExcavatorDataConfig(DataConfigFactory):
    """æŒ–æ˜æœºæ•°æ®å¤„ç†é…ç½®"""

    @override
    def create(self, assets_dirs: pathlib.Path, model_config: _model.BaseModelConfig) -> DataConfig:
        # 1. æ­£ç¡®çš„ Repack æ˜ å°„
        repack_transforms = _transforms.Group(
            inputs=[
                _transforms.RepackTransform(
                    {
                        "image": "image",       # âœ… ä¿®æ­£ï¼šimage
                        "state": "state",
                        "action": "action",     # âœ… ä¿®æ­£ï¼šactionï¼ˆå•æ•°ï¼‰
                    }
                )
            ]
        )

        # 2. ä½¿ç”¨æ–°çš„ Transform ç±»
        data_transforms = _transforms.Group(
            inputs=[droid_policy.ExcavatorInputs(model_type=model_config.model_type)],
            outputs=[droid_policy.ExcavatorOutputs()],
        )

        # 3. æ¨¡å‹ Transform
        model_transforms = ModelTransformFactory(
            default_prompt="predict excavator joint action from joint state"
        )(model_config)

        return dataclasses.replace(
            self.create_base_config(assets_dirs, model_config),
            repack_transforms=repack_transforms,
            data_transforms=data_transforms,
            model_transforms=model_transforms,
            action_sequence_keys=("action",),
        )
```

æ·»åŠ å®Œæ•´è®­ç»ƒé…ç½®ï¼ˆå·²å®Œæˆï¼‰ï¼š

```python
# åœ¨ _CONFIGS åˆ—è¡¨ä¸­æ·»åŠ 
TrainConfig(
    name="pi05_excavator_finetune",

    # æ¨¡å‹é…ç½®
    model=pi0_config.Pi0Config(
        pi05=True,
        action_dim=32,                      # Pi0.5 æ ‡å‡†è¾“å‡º
        action_horizon=10,                  # âœ… æ”¹è¿›ï¼šä» 1 â†’ 10
        max_token_len=128,
        paligemma_variant="gemma_2b_lora",
        action_expert_variant="gemma_300m_lora",
        dtype="bfloat16",
        discrete_state_input=False,
    ),

    # æ•°æ®é…ç½®
    data=LeRobotExcavatorDataConfig(
        repo_id="/root/gpufree-data/lerobot_examples_490_train",
        base_config=DataConfig(prompt_from_task=False),
    ),

    # æƒé‡å’Œå†»ç»“
    weight_loader=weight_loaders.CheckpointWeightLoader(
        "/root/gpufree-data/models/pi05_base/params"
    ),
    freeze_filter=pi0_config.Pi0Config(...).get_freeze_filter(),

    # è®­ç»ƒå‚æ•°
    batch_size=2,
    num_train_steps=20_000,
    ema_decay=None,
    save_interval=5_000,
    keep_period=5_000,
    log_interval=100,
    wandb_enabled=True,

    # å­¦ä¹ ç‡è°ƒåº¦
    lr_schedule=_optimizer.CosineDecaySchedule(
        warmup_steps=1_000,
        peak_lr=5e-5,
        decay_steps=1_000_000,
        decay_lr=5e-5,
    ),
    optimizer=_optimizer.AdamW(clip_gradient_norm=1.0),
),
```

### ä¿®å¤æ•ˆæœ

**éœ€è¦é‡æ–°è®­ç»ƒ**ï¼Œé¢„æœŸï¼š
```
J1 (å¤§è‡‚):  0.257 rad  â†’ 0.257 rad  (æ— å˜åŒ–ï¼Œå·²æ­£å¸¸)
J2 (å°è‡‚):  0.313 rad  â†’ 0.313 rad  (æ— å˜åŒ–ï¼Œå·²æ­£å¸¸)
J3 (é“²æ–—):  1.018 rad  â†’ 0.40 rad   (æ”¹è¿› 61%)
J4 (å›è½¬):  1.185 rad  â†’ 0.50 rad   (æ”¹è¿› 58%) + è§’åº¦åŒ…è£… â†’ 0.40 rad
```

---

## âš ï¸ é—®é¢˜Bï¼šè§’åº¦åŒ…è£…é—®é¢˜

### ç—‡çŠ¶
- ä»…å½±å“ J4ï¼ˆå›è½¬å…³èŠ‚ï¼‰
- çœŸå®å€¼èŒƒå›´ [1.79, 2.77]ï¼Œé¢„æµ‹å€¼èŒƒå›´ [-4.39, 3.12]
- è·¨è¶Š Â±Ï€ è¾¹ç•Œ 201 æ¬¡

### æ ¹æœ¬åŸå› 

å›è½¬å…³èŠ‚çš„çœŸå®å€¼**åªæœ‰æ­£å€¼ï¼Œæ¥è¿‘ Ï€**ï¼Œä½†æ¨¡å‹é¢„æµ‹äº§ç”Ÿå¤§é‡**è´Ÿå€¼**ã€‚

ç®€å• L2 æŸå¤±è®¡ç®—å‡ºå·¨å¤§çš„è·ç¦»ï¼Œä½†å¾ªç¯è·ç¦»å®é™…å¾ˆå°ã€‚

### å¿«é€Ÿä¿®å¤æ–¹æ¡ˆB

**æ–‡ä»¶**ï¼š`test_infer_v3.py`

åœ¨è®¡ç®— MAE ä¹‹å‰æ·»åŠ ï¼ˆæ— éœ€é‡æ–°è®­ç»ƒï¼‰ï¼š

```python
import numpy as np

def apply_angle_wrapping(values, dims=[3]):
    """å¯¹æŒ‡å®šç»´åº¦åº”ç”¨è§’åº¦åŒ…è£…"""
    wrapped = values.copy()
    for dim in dims:
        wrapped[:, dim] = np.arctan2(
            np.sin(values[:, dim]),
            np.cos(values[:, dim])
        )
    return wrapped

# åº”ç”¨åˆ°é¢„æµ‹å’ŒçœŸå®å€¼
predictions = apply_angle_wrapping(predictions)
ground_truth = apply_angle_wrapping(ground_truth)
```

### ä¿®å¤æ•ˆæœ

**ç«‹å³ç”Ÿæ•ˆ**ï¼Œæ— éœ€é‡æ–°è®­ç»ƒï¼š
```
J4 (å›è½¬): 1.185 rad â†’ 0.491 rad (æ”¹è¿› 58.6%)
```

---

## ğŸ¯ å®Œæ•´ä¿®å¤æµç¨‹

### é˜¶æ®µ1ï¼šå¿«é€Ÿæ”¹è¿›ï¼ˆä»Šå¤©ï¼Œ5åˆ†é’Ÿï¼‰

âœ… **åº”ç”¨é—®é¢˜Bçš„ä¿®å¤**ï¼ˆè§’åº¦åŒ…è£…ï¼‰

é¢„æœŸï¼šJ4 æ”¹è¿› 58.6%ï¼Œä» 1.185 â†’ 0.491 rad

```bash
# ä¿®æ”¹ test_infer_v3.py
# æ·»åŠ  apply_angle_wrapping ä»£ç ï¼ˆè§ä¸Šæ–‡ï¼‰

# è¿è¡Œæ¨ç†
python test_infer_v3.py

# éªŒè¯ç»“æœ
cat output_v3/v3_stats.json | python3 -m json.tool
# åº”è¯¥çœ‹åˆ° J4 MAE æ”¹è¿›åˆ° 0.491
```

### é˜¶æ®µ2ï¼šå®Œæ•´æ”¹è¿›ï¼ˆæœ¬å‘¨ï¼Œ6å°æ—¶ï¼‰

âœ… **åº”ç”¨é—®é¢˜Açš„ä¿®å¤**ï¼ˆæ•°æ®å¤„ç†ç®¡é“ + é‡æ–°è®­ç»ƒï¼‰

é¢„æœŸï¼šJ3 æ”¹è¿› 61%ï¼ŒJ4 è¿›ä¸€æ­¥æ”¹è¿›åˆ° 0.40 rad

```bash
# æ­¥éª¤1ï¼šéªŒè¯ä»£ç ä¿®æ”¹å·²å®Œæˆ
python3 -m py_compile openpi/src/openpi/policies/droid_policy.py
python3 -m py_compile openpi/src/openpi/training/config.py

# æ­¥éª¤2ï¼šéªŒè¯è®­ç»ƒæ•°æ®
cd openpi/src/openpi/excavator
python verify_training_data.py

# æ­¥éª¤3ï¼šé‡æ–°è®­ç»ƒ
cd /home/er/Code/openpi-v1
python scripts/serve_policy.py \
  --env DROID \
  policy:checkpoint \
  --policy.config pi05_excavator_finetune \
  --policy.dir /path/to/new/checkpoint
# ç­‰å¾… 4-6 å°æ—¶...

# æ­¥éª¤4ï¼šéªŒè¯æ•ˆæœ
cd openpi/src/openpi/excavator
python test_infer_v3.py
```

---

## ğŸ“ˆ é¢„æœŸæ”¹è¿›å¯¹æ¯”

### ä»…åº”ç”¨é—®é¢˜Bä¿®å¤

```
å…³èŠ‚     åŸå§‹MAE   ä¿®å¤å   æ”¹è¿›
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
J1       0.257    0.257    0%
J2       0.313    0.313    0%
J3       1.018    1.018    0%
J4       1.185    0.491    â†“58.6% âœ…
```

### å®Œå…¨ä¿®å¤ï¼ˆA+Bï¼‰

```
å…³èŠ‚     åŸå§‹MAE   ä¿®å¤å   æ”¹è¿›
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
J1       0.257    0.257    0%
J2       0.313    0.313    0%
J3       1.018    0.40     â†“61% âœ…
J4       1.185    0.40     â†“66% âœ…
```

---

## ğŸ”— ä¸¤ä¸ªé—®é¢˜çš„å…³ç³»

### é—®é¢˜Aï¼ˆæ•°æ®å¤„ç†ï¼‰

```
å½±å“èŒƒå›´ï¼šJ3 + J4
æ ¹æœ¬åŸå› ï¼šé…ç½®é”™è¯¯
ç—‡çŠ¶ï¼šæ¨¡å‹æ— æ³•æ­£ç¡®å­¦ä¹ 
ä¿®å¤ï¼šé‡æ–°è®­ç»ƒï¼ˆ6å°æ—¶ï¼‰
æ•ˆæœï¼šæ°¸ä¹…è§£å†³
```

### é—®é¢˜Bï¼ˆè§’åº¦åŒ…è£…ï¼‰

```
å½±å“èŒƒå›´ï¼šä»… J4
æ ¹æœ¬åŸå› ï¼šå¾ªç¯æ•°æ®çš„è¡¨ç¤ºé—®é¢˜
ç—‡çŠ¶ï¼šè¯„ä¼°æŒ‡æ ‡è¢«å¤¸å¤§
ä¿®å¤ï¼šæ¨ç†åå¤„ç†ï¼ˆ5åˆ†é’Ÿï¼‰
æ•ˆæœï¼šç«‹å³æ”¹è¿›
```

### ä¸ºä»€ä¹ˆè¦åˆ†å¼€ä¿®å¤ï¼Ÿ

- **é—®é¢˜A** å…³ä¹**æ¨¡å‹è´¨é‡**ï¼ˆæ˜¯å¦èƒ½å­¦åˆ°æ­£ç¡®çš„æ˜ å°„ï¼‰
- **é—®é¢˜B** å…³ä¹**è¯„ä¼°æ–¹å¼**ï¼ˆæ˜¯å¦ç”¨æ­£ç¡®çš„è·ç¦»åº¦é‡ï¼‰

å³ä½¿ A å®Œå…¨ä¿®å¤ï¼Œå¦‚æœä¸å¤„ç† Bï¼ŒJ4 ä»ç„¶çœ‹èµ·æ¥å¾ˆå·®ï¼ˆ1.2 radï¼‰ã€‚
å³ä½¿ B å®Œå…¨ä¿®å¤ï¼Œå¦‚æœä¸å¤„ç† Aï¼ŒJ3 ä»ç„¶å¾ˆå·®ï¼ˆ1.0 radï¼‰ã€‚

---

## âœ… éªŒè¯ä¿®å¤

### å¿«é€ŸéªŒè¯ï¼ˆé—®é¢˜Bï¼‰

```bash
# è¿è¡Œè¯Šæ–­å·¥å…·
python angle_wrapping_diagnosis.py

# é¢„æœŸè¾“å‡º
å…³èŠ‚ 4 (å›è½¬ Swing):
  åŸå§‹ MAE:     1.185072 rad
  åŒ…è£…å MAE:   0.490930 rad
  æ”¹è¿›ç¨‹åº¦:     58.6%
```

### å®Œæ•´éªŒè¯ï¼ˆA+Bï¼‰

```bash
# é‡æ–°è®­ç»ƒåè¿è¡Œè¯Šæ–­
python quick_diagnosis.py

# é¢„æœŸæ‰€æœ‰å…³èŠ‚ MAE éƒ½ < 0.5 rad
```

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **ç«‹å³åš**ï¼šåº”ç”¨é—®é¢˜Bä¿®å¤ï¼ˆ5åˆ†é’Ÿï¼‰
2. **æœ¬å‘¨åš**ï¼šåº”ç”¨é—®é¢˜Aä¿®å¤ + é‡æ–°è®­ç»ƒï¼ˆ6å°æ—¶ï¼‰
3. **å¯é€‰**ï¼šæŸ¥çœ‹è¯Šæ–­è„šæœ¬æ–‡æ¡£ [4]ï¼Œä½¿ç”¨å·¥å…·è¿›ä¸€æ­¥åˆ†æ

---

**ä¿®å¤å·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹è¡ŒåŠ¨å§ï¼** ğŸš€
