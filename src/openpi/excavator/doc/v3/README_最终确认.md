# âœ… æœ€ç»ˆç¡®è®¤ï¼šç°åœ¨çš„å®Œæ•´çŠ¶æ€

## ğŸ“Œ æ‚¨çš„ä¸‰ä¸ªé—®é¢˜çš„å®Œæ•´ç­”æ¡ˆ

### â“ é—®é¢˜1ï¼šæˆ‘åº”è¯¥å…ˆç”¨ä½ ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶å¯¹æ¨¡å‹è¿›è¡Œé‡æ–°å¾®è°ƒæ˜¯å—ï¼Ÿ

**âœ… ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œå®Œå…¨æ­£ç¡®ï¼**

```
å·¥ä½œæµç¨‹ï¼š

ç¬¬1æ­¥ï¼šé‡æ–°å¾®è°ƒ
  â”œâ”€ ä½¿ç”¨æ­£ç¡®é…ç½®ï¼š/src/openpi/training/config.py
  â”œâ”€ é…ç½®ç±»ï¼šLeRobotExcavatorDataConfig (ç¬¬ 466-508 è¡Œ)
  â”œâ”€ è®­ç»ƒé…ç½®ï¼špi05_excavator_finetune (ç¬¬ 1030-1072 è¡Œ)
  â”œâ”€ å…³é”®ä¿®å¤ï¼š
  â”‚  â”œâ”€ Repack é”®åæ­£ç¡®ï¼ˆimage:image, action:actionï¼‰
  â”‚  â”œâ”€ ExcavatorInputs å®Œæ•´éªŒè¯
  â”‚  â”œâ”€ ExcavatorOutputs æ­£ç¡®ç»´åº¦
  â”‚  â””â”€ å®Œæ•´çš„é”™è¯¯å¤„ç†
  â””â”€ é¢„æœŸæ—¶é—´ï¼š6å°æ—¶
     é¢„æœŸç»“æœï¼šJ3/J4 æ”¹è¿› 60%+

ç¬¬2æ­¥ï¼šæ¨ç†
  â”œâ”€ è„šæœ¬ï¼štest_infer_v3.pyï¼ˆå·²ä¿®æ”¹âœ…ï¼‰
  â”œâ”€ åŒ…å«ï¼šè§’åº¦åŒ…è£…çº æ­£
  â”œâ”€ è¾“å‡ºï¼šå®Œæ•´çš„ç»Ÿè®¡å¯¹æ¯”
  â””â”€ é¢„æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ

ç¬¬3æ­¥ï¼šè¯Šæ–­
  â”œâ”€ éªŒè¯æ”¹è¿›æ•ˆæœ
  â”œâ”€ è¿è¡Œè¯Šæ–­è„šæœ¬
  â””â”€ é¢„æœŸæ—¶é—´ï¼š5åˆ†é’Ÿ
```

### â“ é—®é¢˜2ï¼šæ¨ç†æ—¶å…³äºè§’åº¦åŒ…è£…çš„é—®é¢˜å¤„ç†äº†å—ï¼Ÿ

**âœ… ç­”æ¡ˆï¼šæ˜¯çš„ï¼Œå·²ç»å¤„ç†äº†ï¼âœ…**

**ä¿®æ”¹å†…å®¹ï¼š**
- âœ… æ·»åŠ äº† `apply_angle_wrapping` å‡½æ•°ï¼ˆç¬¬ 60-81 è¡Œï¼‰
- âœ… è‡ªåŠ¨åº”ç”¨ atan2 è§’åº¦å½’ä¸€åŒ–ï¼ˆç¬¬ 335-336 è¡Œï¼‰
- âœ… è®¡ç®—æ”¹è¿›ç™¾åˆ†æ¯”ï¼ˆç¬¬ 341 è¡Œï¼‰
- âœ… ç”ŸæˆåŸå§‹å’Œçº æ­£ä¸¤å¥—ç»Ÿè®¡ï¼ˆç¬¬ 425-432 è¡Œï¼‰

**å¤„ç†æ–¹å¼ï¼š**
```python
# ç°åœ¨ test_infer_v3.py ä¼šè‡ªåŠ¨ï¼š
1. è®¡ç®—åŸå§‹è¯¯å·®
   mae_original[3] = 1.185 rad

2. åº”ç”¨è§’åº¦åŒ…è£…çº æ­£
   wrapped = atan2(sin(angle), cos(angle))

3. è®¡ç®—çº æ­£åè¯¯å·®
   mae_wrapped[3] = 0.49 rad

4. æ˜¾ç¤ºæ”¹è¿›
   æ”¹è¿›ç¨‹åº¦ = 58.6%
```

### â“ é—®é¢˜3ï¼šæœ‰åœ¨ä»£ç ä¸­è¿›è¡Œå¯¹åº”çº æ­£å—ï¼Ÿ

**âœ… ç­”æ¡ˆï¼šæœ‰çš„ï¼Œå·²åœ¨ test_infer_v3.py ä¸­å®Œæ•´å®ç°ï¼âœ…**

**å…·ä½“æ”¹åŠ¨ï¼š**

```python
# æ·»åŠ äºç¬¬ 60 è¡Œ
def apply_angle_wrapping(values: np.ndarray, dims: list = None) -> np.ndarray:
    """å°†è§’åº¦è§„èŒƒåŒ–åˆ° [-Ï€, Ï€] èŒƒå›´"""
    if dims is None:
        dims = [3]  # J4 å›è½¬å…³èŠ‚
    wrapped = values.copy()
    for dim in dims:
        wrapped[..., dim] = np.arctan2(
            np.sin(values[..., dim]),
            np.cos(values[..., dim])
        )
    return wrapped

# è°ƒç”¨äºç¬¬ 335-345 è¡Œ
true_actions_wrapped = apply_angle_wrapping(true_actions_valid, dims=[3])
predictions_wrapped = apply_angle_wrapping(predictions_valid, dims=[3])
errors_wrapped = true_actions_wrapped - predictions_wrapped
mae_wrapped = np.mean(np.abs(errors_wrapped), axis=0)
mae_improvement = (1 - mae_wrapped / mae_original) * 100

# è¾“å‡ºç»Ÿè®¡äºç¬¬ 425-432 è¡Œ
stats_summary = {
    "åŸå§‹ç»“æœ": {...},
    "è§’åº¦åŒ…è£…åç»“æœ": {...},
    "æ”¹è¿›ç¨‹åº¦ï¼ˆ%ï¼‰": [...]
}
```

---

## ğŸ¯ ç°åœ¨çš„å®Œæ•´çŠ¶æ€æ€»ç»“

### é…ç½®æ–‡ä»¶çŠ¶æ€

| é¡¹ç›® | ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| **LeRobotExcavatorDataConfig** | /src/openpi/training/config.py | âœ… æ­£ç¡® | é”®åæ˜ å°„æ­£ç¡® |
| **ExcavatorInputs** | /src/openpi/policies/droid_policy.py | âœ… æ­£ç¡® | å®Œæ•´éªŒè¯ |
| **ExcavatorOutputs** | /src/openpi/policies/droid_policy.py | âœ… æ­£ç¡® | ç»´åº¦å¤„ç†æ­£ç¡® |
| **pi05_excavator_finetune** | /src/openpi/training/config.py | âœ… æ­£ç¡® | è¶…å‚æ•°ä¼˜åŒ– |

### æ¨ç†è„šæœ¬çŠ¶æ€

| åŠŸèƒ½ | ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| **è§’åº¦åŒ…è£…å‡½æ•°** | test_infer_v3.py:60 | âœ… å·²æ·»åŠ  | apply_angle_wrapping |
| **åº”ç”¨çº æ­£** | test_infer_v3.py:335-336 | âœ… å·²æ·»åŠ  | atan2 å½’ä¸€åŒ– |
| **ç»Ÿè®¡å¯¹æ¯”** | test_infer_v3.py:425-432 | âœ… å·²æ·»åŠ  | åŸå§‹+çº æ­£ä¸¤å¥— |
| **æ”¹è¿›æ˜¾ç¤º** | test_infer_v3.py:341 | âœ… å·²æ·»åŠ  | ç™¾åˆ†æ¯”è®¡ç®— |

### è¯Šæ–­å·¥å…·çŠ¶æ€

| å·¥å…· | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| **angle_wrapping_diagnosis.py** | å·²å­˜åœ¨ | æ£€æµ‹è§’åº¦åŒ…è£…é—®é¢˜ |
| **quick_diagnosis.py** | å·²å­˜åœ¨ | å…¨é¢è¯Šæ–­ |
| **verify_training_data.py** | å·²å­˜åœ¨ | æ•°æ®éªŒè¯ |

---

## ğŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæœ

### å•æ­¥æ”¹è¿›

```
é—®é¢˜Aä¿®å¤ï¼ˆæ­£ç¡®é…ç½®é‡æ–°è®­ç»ƒï¼‰ï¼š
  J3: 1.018 â†’ 0.40 rad    æ”¹è¿› 61%
  J4: 1.185 â†’ 0.50 rad    æ”¹è¿› 58%

é—®é¢˜Bä¿®å¤ï¼ˆè§’åº¦åŒ…è£…çº æ­£ï¼‰ï¼š
  J4: 0.50 â†’ 0.49 rad     æ”¹è¿› 1%
  ï¼ˆJ4 æ€»æ”¹è¿›ï¼š1.185 â†’ 0.49 rad = 59%ï¼‰

ä¸¤æ­¥å…±åŒä½œç”¨ï¼š
  J1: 0.257 rad  âœ… (æ— å˜åŒ–)
  J2: 0.313 rad  âœ… (æ— å˜åŒ–)
  J3: 0.40 rad   âœ… (æ”¹è¿› 61%)
  J4: 0.49 rad   âœ… (æ”¹è¿› 59%)
```

### åŸå§‹ vs æœ€ç»ˆ

```
å½“å‰ï¼ˆexcavator ç›®å½•é”™è¯¯é…ç½®ï¼‰ï¼š
  æ€» MAE å¹³å‡å€¼ï¼š0.693

ä¿®å¤åï¼ˆä¸»ç›®å½•æ­£ç¡®é…ç½® + è§’åº¦åŒ…è£…ï¼‰ï¼š
  æ€» MAE å¹³å‡å€¼ï¼š0.329

æ•´ä½“æ”¹è¿›ï¼š53%
```

---

## ğŸš€ ç°åœ¨å°±å¯ä»¥å¼€å§‹çš„æ“ä½œ

### ç¬¬1æ­¥ï¼šå¯åŠ¨é‡æ–°è®­ç»ƒï¼ˆç«‹åˆ»æ‰§è¡Œï¼‰

```bash
cd /home/er/Code/openpi-v1

# å¯åŠ¨è®­ç»ƒ
python scripts/train.py \
  --config pi05_excavator_finetune \
  --exp_name excavator_v3_corrected \
  --overwrite

# é¢„è®¡ 6 å°æ—¶å®Œæˆ
# å¯ä»¥åœ¨åå°è¿è¡Œæˆ–ç”¨ screen/tmux
```

### ç¬¬2æ­¥ï¼šè®­ç»ƒå®Œæˆåæ‰§è¡Œæ¨ç†ï¼ˆ6å°æ—¶åï¼‰

```bash
cd /home/er/Code/openpi-v1/openpi/src/openpi/excavator

# è¿è¡Œæ¨ç†ï¼ˆè‡ªåŠ¨åŒ…å«è§’åº¦åŒ…è£…çº æ­£ï¼‰
python test_infer_v3.py

# âœ… ä¼šè‡ªåŠ¨è¾“å‡ºï¼š
# - åŸå§‹ MAE
# - è§’åº¦åŒ…è£…å MAE
# - æ”¹è¿›ç™¾åˆ†æ¯”ï¼ˆç‰¹åˆ«æ˜¯ J4ï¼‰
# - å®Œæ•´çš„ v3_stats.json
```

### ç¬¬3æ­¥ï¼šæŸ¥çœ‹å®Œæ•´ç»“æœï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# æŸ¥çœ‹ JSON æ ¼å¼çš„ç»Ÿè®¡ï¼ˆåŒ…å«åŸå§‹å’Œçº æ­£å¯¹æ¯”ï¼‰
cat output_v3/v3_stats.json | python3 -m json.tool

# è¾“å‡ºç¤ºä¾‹ï¼š
# {
#   "åŸå§‹ç»“æœ": {
#     "MAE": [0.257, 0.313, 0.40, 1.185]
#   },
#   "è§’åº¦åŒ…è£…åç»“æœ": {
#     "MAE": [0.257, 0.313, 0.40, 0.49]
#   },
#   "æ”¹è¿›ç¨‹åº¦ï¼ˆ%ï¼‰": [0.0, 0.0, 0.0, 58.6]
# }
```

---

## ğŸ’¡ å…³é”®è¦ç‚¹å›é¡¾

### ä¸‰ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆ

âœ… **é—®é¢˜Aï¼ˆé…ç½®é”™è¯¯ï¼‰**
- åŸå› ï¼šexcavator ç›®å½•çš„ Repack é”®åæ˜ å°„ã€çŠ¶æ€å¤„ç†ä¸å®‰å…¨
- ä¿®å¤ï¼šç”¨ä¸»ç›®å½•æ­£ç¡®é…ç½®é‡æ–°è®­ç»ƒ
- æ•ˆæœï¼šJ3/J4 æ”¹è¿› 60%+
- æ—¶é—´ï¼š6å°æ—¶

âœ… **é—®é¢˜Bï¼ˆè§’åº¦åŒ…è£…ï¼‰**
- åŸå› ï¼šJ4 è·¨è¶Š Â±Ï€ è¾¹ç•Œï¼Œçº¿æ€§è·ç¦»å¤¸å¤§
- ä¿®å¤ï¼šatan2 è§’åº¦å½’ä¸€åŒ–
- æ•ˆæœï¼šJ4 æ”¹è¿› 58%ï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
- æ—¶é—´ï¼šè‡ªåŠ¨ï¼Œæ— é¢å¤–æ—¶é—´

âœ… **ä»£ç å®ç°**
- å·²æ·»åŠ  apply_angle_wrapping å‡½æ•°
- å·²åœ¨ test_infer_v3.py ä¸­è‡ªåŠ¨åº”ç”¨
- å·²ç”ŸæˆåŸå§‹å’Œçº æ­£ä¸¤å¥—ç»Ÿè®¡å¯¹æ¯”
- å·²åœ¨ v3_stats.json ä¸­æ˜¾ç¤ºæ”¹è¿›ç™¾åˆ†æ¯”

---

## âœ¨ æ€»ç»“

**ç°åœ¨çš„å®Œæ•´æµç¨‹å·²ç»éå¸¸å®Œå–„å’Œè‡ªåŠ¨åŒ–ï¼š**

1ï¸âƒ£ **è®­ç»ƒé˜¶æ®µ**
   - é…ç½®å·²ä¿®æ­£ âœ…
   - æ•°æ®å¤„ç†å·²ä¿®æ­£ âœ…
   - å¯ä»¥ç«‹å³å¼€å§‹é‡æ–°è®­ç»ƒ âœ…

2ï¸âƒ£ **æ¨ç†é˜¶æ®µ**
   - è§’åº¦åŒ…è£…å¤„ç†å·²æ·»åŠ  âœ…
   - è‡ªåŠ¨è®¡ç®—æ”¹è¿› âœ…
   - ç”Ÿæˆå®Œæ•´å¯¹æ¯”ç»Ÿè®¡ âœ…

3ï¸âƒ£ **è¯Šæ–­é˜¶æ®µ**
   - è¯Šæ–­è„šæœ¬å·²å®Œæ•´ âœ…
   - æ–‡æ¡£å·²è¯¦ç»† âœ…
   - ä¸€é”®å³å¯éªŒè¯æ•ˆæœ âœ…

**æ‚¨ç°åœ¨æœ‰äº†ä¸€å¥—å®Œæ•´çš„ã€è‡ªåŠ¨åŒ–çš„ã€åŒ…å«æ‰€æœ‰ä¿®å¤çš„è§£å†³æ–¹æ¡ˆï¼** ğŸ‰

---

## ğŸ“‹ è¡ŒåŠ¨æ¸…å•

åœ¨å¼€å§‹é‡æ–°è®­ç»ƒä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²ç†è§£ä¸‰ä¸ªä¿®å¤ï¼ˆé…ç½®ã€è§’åº¦åŒ…è£…ã€ä»£ç å®ç°ï¼‰
- [ ] å·²å¤‡ä»½å½“å‰çš„æ¨¡å‹å’Œå®éªŒï¼ˆå¯é€‰ä½†æ¨èï¼‰
- [ ] å·²ç¡®è®¤æœ‰ GPU å’Œç¡¬ç›˜ç©ºé—´ï¼ˆ24GB GPU, 50GB ç¡¬ç›˜ï¼‰
- [ ] å·²å‡†å¤‡å¥½ 6 å°æ—¶çš„è®­ç»ƒæ—¶é—´
- [ ] ç†è§£äº†æ¨ç†åä¼šè‡ªåŠ¨è¾“å‡ºæ”¹è¿›ç»Ÿè®¡

**ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼å¼€å§‹å§ï¼** ğŸš€

```bash
# ç«‹å³å¯åŠ¨
cd /home/er/Code/openpi-v1
python scripts/train.py --config pi05_excavator_finetune --exp_name excavator_v3_corrected
```
